{"metadata": {"dbt_schema_version": "https://schemas.getdbt.com/dbt/run-results/v6.json", "dbt_version": "1.9.2", "generated_at": "2025-03-30T14:42:15.199281Z", "invocation_id": "196b55ba-907b-4947-9e9f-26e352c9fd35", "env": {}}, "results": [{"status": "success", "timing": [{"name": "compile", "started_at": "2025-03-30T14:41:32.750361Z", "completed_at": "2025-03-30T14:41:32.802031Z"}, {"name": "execute", "started_at": "2025-03-30T14:41:32.803506Z", "completed_at": "2025-03-30T14:41:37.173782Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 4.427085638046265, "adapter_response": {"_message": "CREATE TABLE (3.4k rows, 1.3 MiB processed)", "code": "CREATE TABLE", "rows_affected": 3352, "bytes_processed": 1367711, "bytes_billed": 10485760, "location": "US", "project_id": "gerolingcp", "job_id": "c4082bae-7aba-4120-98fd-38d6ede48785", "slot_ms": 4037}, "message": "CREATE TABLE (3.4k rows, 1.3 MiB processed)", "failures": null, "unique_id": "model.fiosiovet.animals", "compiled": true, "compiled_code": "\n    SELECT \n        Animal_Codigo AS Codigo,\n        Cliente_Codigo,\n        Animal_Nome AS Nome,\n        Animal_Especie AS Especie,\n        Animal_Raca AS Raca,\n        Animal_Pelagem AS Pelagem,\n        Animal_Esterilizacao AS Esterilizacao,\n        Animal_Nascimento AS DataNascimento,\n        Animal_Sexo AS Sexo,\n        Animal_Pedigree AS Pedigree,\n        Animal_Chip AS Chip,\n        Animal_Tags AS Tags,\n        Animal_Status AS Status,\n        Animal_Datadeinclusao AS DataInclusao,\n        Animal_Vivo_Morto AS VivoMorto\n    FROM `gerolingcp.FisioVet_External.clients_animals`", "relation_name": "`gerolingcp`.`FisioVet`.`animals`", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-03-30T14:41:37.216713Z", "completed_at": "2025-03-30T14:41:37.238095Z"}, {"name": "execute", "started_at": "2025-03-30T14:41:37.240062Z", "completed_at": "2025-03-30T14:41:41.126297Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 3.912416458129883, "adapter_response": {"_message": "CREATE TABLE (3.0k rows, 1.3 MiB processed)", "code": "CREATE TABLE", "rows_affected": 3024, "bytes_processed": 1367711, "bytes_billed": 10485760, "location": "US", "project_id": "gerolingcp", "job_id": "109f7d53-fc16-4657-856b-14b15190cbae", "slot_ms": 3344}, "message": "CREATE TABLE (3.0k rows, 1.3 MiB processed)", "failures": null, "unique_id": "model.fiosiovet.clients", "compiled": true, "compiled_code": "\n    SELECT DISTINCT\n        Cliente_Codigo AS Codigo,\n        Cliente_Nome AS Nome,\n        REPLACE(REPLACE(Cliente_CPF,'.',''),'-','') AS CPF,\n        REPLACE(REPLACE(Cliente_RG,'.',''),'-','') AS RG,\n        Cliente_Sexo AS Sexo,\n        Cliente_Email AS Email,\n        Cliente_Telefones AS Telefone,\n        Cliente_Endereco AS Endereco,\n        Cliente_Bairro AS Bairro,\n        Cliente_Cidade AS Cidade,\n        Cliente_UF AS UF,\n        Cliente_CEP AS CEP,\n        Cliente_Datadeinclusao AS DataInclusao,\n        Cliente_Datadaultimaatualizacao AS DataUltimaAtualizacao,\n        Cliente_Origem AS Origem,\n        Cliente_NPS AS NPS,\n        Cliente_RankingABC AS RankingABC,\n        REPLACE(Cliente_Valorpagonosultimos30dias,'R$ ','') AS ValorPago30,\n        REPLACE(Cliente_Valorpagonosultimos90dias,'R$ ','') AS ValorPago90,\n        REPLACE(Cliente_Valorpagonosultimos180dias,'R$ ','') AS ValorPago180,\n        REPLACE(Cliente_Valorpagonosultimos365dias,'R$ ','') AS ValorPago365,\n        REPLACE(Cliente_Ticketmedio,'R$ ','') AS TicketMedio,\n        Cliente_Datadaprimeiracompra AS DataPrimeiraCompra,\n        Cliente_Ultimavenda AS UltimaVenda,\n        Cliente_UltimoacessoaoSimplesPet AS UltimoAcessoSimplesPet,\n        Cliente_Tags AS Tags\n    FROM `gerolingcp.FisioVet_External.clients_animals`", "relation_name": "`gerolingcp`.`FisioVet`.`clients`", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-03-30T14:41:41.180517Z", "completed_at": "2025-03-30T14:41:41.211098Z"}, {"name": "execute", "started_at": "2025-03-30T14:41:41.212844Z", "completed_at": "2025-03-30T14:41:48.720167Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 7.5470194816589355, "adapter_response": {"_message": "MERGE (204.0 rows, 76.6 KiB processed)", "code": "MERGE", "rows_affected": 204, "bytes_processed": 78397, "bytes_billed": 20971520, "location": "US", "project_id": "gerolingcp", "job_id": "7d5ab2a2-b05b-4582-91ba-59fbf7563900", "slot_ms": 88651}, "message": "MERGE (204.0 rows, 76.6 KiB processed)", "failures": null, "unique_id": "model.fiosiovet.debts", "compiled": true, "compiled_code": "\n    SELECT \n        Data,\n        Conta,\n        Categoria,\n        Descricao,\n        Fornecedor,\n        Parcela,\n        Data as Competencia,\n        Valor,\n        Desconto,\n        Multa,\n        Juros,\n        Vencimento,\n        Pagamento,\n        Valorpago AS ValorPago,\n        Formadepagamento AS FormaPagamento,\n        Documento_NF AS DocumentoNF,\n        Observacao,\n        date\n    FROM `gerolingcp.FisioVet_External.debts`", "relation_name": "`gerolingcp`.`FisioVet`.`debts`", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-03-30T14:41:48.737683Z", "completed_at": "2025-03-30T14:41:48.769300Z"}, {"name": "execute", "started_at": "2025-03-30T14:41:48.770541Z", "completed_at": "2025-03-30T14:42:01.336236Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 12.602133750915527, "adapter_response": {"_message": "SCRIPT (2.5 MiB processed)", "code": "SCRIPT", "bytes_processed": 2657686, "bytes_billed": 52428800, "location": "US", "project_id": "gerolingcp", "job_id": "fab60f30-efa4-4d6d-a99a-8d7b63285d34", "slot_ms": 197076}, "message": "SCRIPT (2.5 MiB processed)", "failures": null, "unique_id": "model.fiosiovet.sales", "compiled": true, "compiled_code": "\nSELECT  \n        CAST(Dataehora AS DATETIME FORMAT 'DD/MM/YYYY HH24:MI') AS DataHora,\n        Venda,\n        Statusdavenda AS Status,\n        SAFE_CAST(Databaixa AS DATE FORMAT 'DD/MM/YYYY') AS DataBaixa,\n        Formapagamento AS FormaPagamento,\n        Funcionario,\n        Cliente AS NomeCliente,\n        Codigo AS CodigoCliente,\n        Animal AS NomeAnimal,\n        Especie,\n        Sexo_1 AS SexoAnimal,\n        Raca,\n        TipodoItem AS TipoItem,\n        Grupo,\n        Produto_servico AS ProdutoServico,\n        CAST(REPLACE(REPLACE(ValorUnitario,'.',''),',','.') AS NUMERIC) AS ValorUnitario,\n        Quantidade,\n        CAST(REPLACE(REPLACE(Bruto,'.',''),',','.') AS NUMERIC) AS Bruto,\n        CAST(REPLACE(REPLACE(Desconto,'.',''),',','.') AS NUMERIC) AS Desconto,\n        CAST(REPLACE(REPLACE(Liquido,'.',''),',','.') AS NUMERIC) AS Liquido,\n        Observacoes,\n        date\n    FROM `gerolingcp.FisioVet_External.sales`\n\n    \n       where date >= (select \n\n        datetime_add(\n            cast( max(date) as datetime),\n        interval -90 day\n        )\n\n from `gerolingcp`.`FisioVet`.`sales`) \n    \n\nQUALIFY ROW_NUMBER()OVER(PARTITION BY Venda,Codigo,Animal,Produto_Servico ORDER BY Venda) = 1", "relation_name": "`gerolingcp`.`FisioVet`.`sales`", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-03-30T14:42:01.460345Z", "completed_at": "2025-03-30T14:42:01.682710Z"}, {"name": "execute", "started_at": "2025-03-30T14:42:01.684618Z", "completed_at": "2025-03-30T14:42:06.224104Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 4.798446893692017, "adapter_response": {"_message": "MERGE (2.0k rows, 926.1 KiB processed)", "code": "MERGE", "rows_affected": 2032, "bytes_processed": 948363, "bytes_billed": 31457280, "location": "US", "project_id": "gerolingcp", "job_id": "354748e5-d41c-4b28-ac4a-e56e7e3b1d62", "slot_ms": 69129}, "message": "MERGE (2.0k rows, 926.1 KiB processed)", "failures": null, "unique_id": "model.fiosiovet.faturamento_cliente", "compiled": true, "compiled_code": "\n    SELECT \n        S.CodigoCliente\n        ,C.Nome\n        ,S.ProdutoServico\n        ,FORMAT_DATE('%Y-%m-01', DataHora) AS AnoMes\n        ,COUNT(Venda) AS Atendimentos\n        ,SUM(Liquido) AS ValorLiquido\n        ,SUM(IF(Status = 'Baixado',Liquido,0)) AS ValorRecebido\n        ,SUM(IF(Status = 'Aberto',Liquido,0)) AS ValorEmAberto\n    FROM `gerolingcp`.`FisioVet`.`sales` S\n    JOIN `gerolingcp`.`FisioVet`.`clients` C \n        ON S.CodigoCliente = C.Codigo\n    WHERE \n        date > \"2023-01-01\" \n    GROUP BY \n        S.CodigoCliente\n        ,C.Nome\n        ,S.ProdutoServico\n        ,FORMAT_DATE('%Y-%m-01', DataHora)", "relation_name": "`gerolingcp`.`FisioVet_Analytics`.`faturamento_cliente`", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-03-30T14:42:06.237353Z", "completed_at": "2025-03-30T14:42:06.257799Z"}, {"name": "execute", "started_at": "2025-03-30T14:42:06.259076Z", "completed_at": "2025-03-30T14:42:10.421735Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 4.186879396438599, "adapter_response": {"_message": "MERGE (118.0 rows, 292.9 KiB processed)", "code": "MERGE", "rows_affected": 118, "bytes_processed": 299942, "bytes_billed": 20971520, "location": "US", "project_id": "gerolingcp", "job_id": "6119004c-b89d-4f40-8859-b9b20a283649", "slot_ms": 40084}, "message": "MERGE (118.0 rows, 292.9 KiB processed)", "failures": null, "unique_id": "model.fiosiovet.faturamento_funcionario", "compiled": true, "compiled_code": "\n    SELECT \n        Funcionario\n        ,FORMAT_DATE('%Y-%m-01', DataHora) AS AnoMes\n        ,COUNT(Venda) AS Atendimentos\n        ,SUM(Liquido) AS ValorLiquido\n    FROM `gerolingcp`.`FisioVet`.`sales` \n    GROUP BY \n        Funcionario\n        ,FORMAT_DATE('%Y-%m-01', DataHora)", "relation_name": "`gerolingcp`.`FisioVet_Analytics`.`faturamento_funcionario`", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-03-30T14:42:10.441433Z", "completed_at": "2025-03-30T14:42:10.464306Z"}, {"name": "execute", "started_at": "2025-03-30T14:42:10.465802Z", "completed_at": "2025-03-30T14:42:15.127008Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 4.688785552978516, "adapter_response": {"_message": "CREATE TABLE (40.0 rows, 472.0 KiB processed)", "code": "CREATE TABLE", "rows_affected": 40, "bytes_processed": 483345, "bytes_billed": 52428800, "location": "US", "project_id": "gerolingcp", "job_id": "5cdee0b1-f0b0-44c9-b5d4-29fd5a9fb876", "slot_ms": 111010}, "message": "CREATE TABLE (40.0 rows, 472.0 KiB processed)", "failures": null, "unique_id": "model.fiosiovet.resultado_operacional", "compiled": true, "compiled_code": "\nWITH Receita AS \n(\n  SELECT\n    FORMAT_DATE('%Y-%m-01', date) AS Mes,\n    SE.Local,\n    ROUND(SUM(CAST(Liquido AS FLOAT64)),2) AS ValorTotal,\n    COUNT(1) AS Atendimentos\n  FROM `gerolingcp.FisioVet.sales` SA\n  JOIN `gerolingcp.FisioVet.services` SE\n    ON SA.ProdutoServico = SE.Servico\n  GROUP BY\n    FORMAT_DATE('%Y-%m-01', date),\n    SE.Local\n),\nCustoFixo AS\n(\n  SELECT \n    FORMAT_DATE('%Y-%m-01', date) AS Mes,\n    DT.Local,\n    ROUND(SUM(CAST(ValorPago AS FLOAT64)),2) AS TotalPago\n  FROM `gerolingcp`.`FisioVet`.`debts`  D\n  JOIN `gerolingcp.FisioVet.debts_types` DT\n    ON D.Categoria = DT.CategoriaDebito\n  WHERE DT.Tipo = 'Fixo'\n  GROUP BY \n    FORMAT_DATE('%Y-%m-01', date),\n    Local\n)\n,CustoVariavel AS\n(\n  SELECT \n    FORMAT_DATE('%Y-%m-01', date) AS Mes,\n    DT.Local,\n    ROUND(SUM(CAST(D.ValorPago AS FLOAT64)),2) AS TotalPago\n  FROM `gerolingcp`.`FisioVet`.`debts`  D\n  JOIN `gerolingcp.FisioVet.debts_types` DT\n    ON D.Categoria = DT.CategoriaDebito\n  WHERE DT.Tipo = 'Vari\u00e1vel'\n  GROUP BY \n    FORMAT_DATE('%Y-%m-01', date),\n    DT.Local\n)\n,Comissoes AS\n(\n  SELECT\n    FORMAT_DATE('%Y-%m-01', date) AS Mes,\n    SE.Local,\n    ROUND(SUM((CAST(S.Liquido AS FLOAT64)*(C.Comissao/100))),2) AS Comissao\n  FROM `gerolingcp`.`FisioVet`.`sales`  S\n  JOIN `FisioVet.commission` C\n    ON S.Funcionario = C.Funcionario\n    AND S.ProdutoServico = C.ProdutoServico\n  JOIN `FisioVet.services` SE\n    ON S.ProdutoServico = SE.Servico\n  GROUP BY\n    FORMAT_DATE('%Y-%m-01', date),\n    SE.Local\n)\nSELECT \n  R.Mes, \n  R.Local,\n  R.Atendimentos,\n  R.ValorTotal AS Receita,\n  ROUND(\n    (R.ValorTotal / R.Atendimentos)\n  ,2) AS TicketMedio,\n  IFNULL(CF.TotalPago,0) AS CustoFixo,\n  ROUND(\n    (IFNULL(CF.TotalPago,0) / R.Atendimentos)\n  ,2) AS CustoFixoPorAtendimento,\n  ROUND(\n    (R.ValorTotal - IFNULL(CF.TotalPago,0))\n  ,2) AS LucroBruto, \n  IFNULL(CV.TotalPago,0) AS CustoVariavel,\n  ROUND(\n    (IFNULL(CV.TotalPago,0) / R.Atendimentos)\n  ,2) AS CustoVariavelPorAtendimento,\n  IFNULL(CC.Comissao,0) AS CustoComissoes,\n  ROUND(\n    (IFNULL(CC.Comissao,0) / R.Atendimentos)\n  ,2) AS CustoComissoesPorAtendimento,\n  ROUND(\n    (IFNULL(CC.Comissao,0) / R.ValorTotal )  * 100\n  ,2) AS PorcentagemMediaComissoes,\n  ROUND(\n    (R.ValorTotal - IFNULL(CF.TotalPago,0) - IFNULL(CV.TotalPago,0) - IFNULL(CC.Comissao,0)\n  ),2) AS LucroLiquido,\n  ROUND(\n    ((R.ValorTotal - IFNULL(CF.TotalPago,0) - IFNULL(CV.TotalPago,0) - IFNULL(CC.Comissao,0)) / R.Atendimentos)\n  ,2) AS LucroLiquidoPorAtendimento\nFROM Receita R\nLEFT JOIN CustoFixo CF\n  ON R.Mes = CF.Mes\n  AND R.Local = CF.Local\nLEFT JOIN CustoVariavel CV\n  ON R.Mes = CV.Mes\n  AND R.Local = CV.Local\nLEFT JOIN Comissoes CC\n  ON R.Mes = CC.Mes\n  AND R.Local = CC.Local", "relation_name": "`gerolingcp`.`FisioVet_Analytics`.`resultado_operacional`", "batch_results": null}], "elapsed_time": 45.427905321121216, "args": {"write_json": true, "send_anonymous_usage_stats": true, "partial_parse": true, "invocation_command": "dbt run --profiles-dir /opt/airflow/dags/FisioVet/.dbt --project-dir /opt/airflow/dags/FisioVet/.dbt", "populate_cache": true, "introspect": true, "require_nested_cumulative_type_params": false, "static_parser": true, "log_level": "info", "log_path": "/opt/airflow/dags/FisioVet/.dbt/logs", "state_modified_compare_vars": false, "require_resource_names_without_spaces": false, "macro_debugging": false, "skip_nodes_if_on_run_start_fails": false, "use_colors": true, "select": [], "strict_mode": false, "state_modified_compare_more_unrendered_values": false, "use_colors_file": true, "favor_state": false, "require_yaml_configuration_for_mf_time_spines": false, "which": "run", "version_check": true, "show_resource_report": false, "cache_selected_only": false, "printer_width": 80, "defer": false, "print": true, "exclude": [], "log_file_max_bytes": 10485760, "log_format": "default", "project_dir": "/opt/airflow/dags/FisioVet/.dbt", "vars": {}, "warn_error_options": {"include": [], "exclude": []}, "empty": false, "indirect_selection": "eager", "log_level_file": "debug", "require_batched_execution_for_custom_microbatch_strategy": false, "log_format_file": "debug", "quiet": false, "source_freshness_run_project_hooks": false, "partial_parse_file_diff": true, "profiles_dir": "/opt/airflow/dags/FisioVet/.dbt", "require_explicit_package_overrides_for_builtin_materializations": true}}